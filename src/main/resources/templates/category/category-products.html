<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="'QuickFood - ' + ${category != null ? category.name : '–ö–∞—Ç–µ–≥–æ—Ä–∏—è'}">QuickFood - –ö–∞—Ç–µ–≥–æ—Ä–∏—è</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="/css/bolt-navigation.css">
  <link rel="stylesheet" href="/css/category/category-products.css">
</head>
<body>

<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
<div th:replace="~{fragments/navigation :: navigation}"></div>

<div class="container">
  <!-- Breadcrumb –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
  <div class="breadcrumb">
    <a href="/"><i class="fas fa-home"></i> –ì–ª–∞–≤–Ω–∞—è</a>
    <span> / </span>
    <a href="/categories"><i class="fas fa-utensils"></i> –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</a>
    <span> / </span>
    <span th:text="${category != null ? category.name : '–ö–∞—Ç–µ–≥–æ—Ä–∏—è'}">–ü–∏—Ü—Ü–∞</span>
  </div>

  <!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö -->
  <div th:if="${error}" class="message error-message">
    <i class="fas fa-exclamation-triangle"></i>
    <span th:text="${error}">–û—à–∏–±–∫–∞</span>
  </div>

  <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ -->
  <div th:if="${message}" class="message info-message">
    <i class="fas fa-info-circle"></i>
    <span th:text="${message}">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</span>
  </div>

  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
  <div th:if="${categoryFound}" class="category-header">
    <h1 class="category-title">
      <!-- –≠–º–æ–¥–∑–∏ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
      <span th:switch="${category.name}">
                <span th:case="'–ü–∏—Ü—Ü–∞'">üçï</span>
                <span th:case="'–°—É—à–∏'">üç£</span>
                <span th:case="'–ë—É—Ä–≥–µ—Ä—ã'">üçî</span>
                <span th:case="'–ê–∑–∏–∞—Ç—Å–∫–∞—è'">üçú</span>
                <span th:case="'–ó–¥–æ—Ä–æ–≤–∞—è –µ–¥–∞'">ü•ó</span>
                <span th:case="'–î–µ—Å–µ—Ä—Ç—ã'">üç∞</span>
                <span th:case="'–ö–æ—Ñ–µ'">‚òï</span>
                <span th:case="'–§–∞—Å—Ç—Ñ—É–¥'">ü•ô</span>
                <span th:case="*">üçΩÔ∏è</span>
            </span>
      <span th:text="${category.name}">–ü–∏—Ü—Ü–∞</span>
    </h1>
    <p class="category-subtitle">–õ—É—á—à–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</p>
    <div class="category-stats" th:if="${totalCount != null}">
      –ù–∞–π–¥–µ–Ω–æ <strong th:text="${totalCount}">0</strong> —Ç–æ–≤–∞—Ä–æ–≤
    </div>
  </div>

  <!-- –§–∏–ª—å—Ç—Ä—ã –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
  <div th:if="${hasProducts}" class="filters-section">
    <div class="filters-header">
      <div class="filters-title">
        <i class="fas fa-filter"></i>
        –§–∏–ª—å—Ç—Ä—ã –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
      </div>
      <div class="results-count" th:text="'–ü–æ–∫–∞–∑–∞–Ω–æ ' + ${products.size()} + ' –∏–∑ ' + ${totalCount} + ' —Ç–æ–≤–∞—Ä–æ–≤'">
        –ü–æ–∫–∞–∑–∞–Ω–æ 10 –∏–∑ 25 —Ç–æ–≤–∞—Ä–æ–≤
      </div>
    </div>
    <div class="filters-row">
      <div class="filter-group">
        <label for="sortBy">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</label>
        <select id="sortBy" name="sortBy" th:onchange="'updateFilters()'">
          <option value="name" th:selected="${sortBy == 'name'}">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
          <option value="price" th:selected="${sortBy == 'price'}">–ü–æ —Ü–µ–Ω–µ (–≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏–µ)</option>
          <option value="price_desc" th:selected="${sortBy == 'price_desc'}">–ü–æ —Ü–µ–Ω–µ (—É–±—ã–≤–∞–Ω–∏–µ)</option>
          <option value="popular" th:selected="${sortBy == 'popular'}">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ</option>
          <option value="discount" th:selected="${sortBy == 'discount'}">–°–æ —Å–∫–∏–¥–∫–æ–π</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="priceRange">–¶–µ–Ω–∞:</label>
        <select id="priceRange" name="priceRange" th:onchange="'updateFilters()'">
          <option value="" th:selected="${priceRange == null or priceRange == ''}">–õ—é–±–∞—è</option>
          <option value="0-500" th:selected="${priceRange == '0-500'}">–î–æ 500‚ÇΩ</option>
          <option value="500-1000" th:selected="${priceRange == '500-1000'}">500-1000‚ÇΩ</option>
          <option value="1000-2000" th:selected="${priceRange == '1000-2000'}">1000-2000‚ÇΩ</option>
          <option value="2000+" th:selected="${priceRange == '2000+'}">–û—Ç 2000‚ÇΩ</option>
        </select>
      </div>
    </div>
  </div>

  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
  <div th:if="${hasProducts}" class="products-stats">
    <div class="stat-item" th:if="${minPrice != null}">
      <div class="stat-value" th:text="${minPrice} + '‚ÇΩ'">450‚ÇΩ</div>
      <div class="stat-label">–ú–∏–Ω. —Ü–µ–Ω–∞</div>
    </div>
    <div class="stat-item" th:if="${maxPrice != null}">
      <div class="stat-value" th:text="${maxPrice} + '‚ÇΩ'">1200‚ÇΩ</div>
      <div class="stat-label">–ú–∞–∫—Å. —Ü–µ–Ω–∞</div>
    </div>
    <div class="stat-item" th:if="${averagePrice != null}">
      <div class="stat-value" th:text="${averagePrice} + '‚ÇΩ'">850‚ÇΩ</div>
      <div class="stat-label">–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞</div>
    </div>
    <div class="stat-item" th:if="${uniqueStoresCount != null}">
      <div class="stat-value" th:text="${uniqueStoresCount}">5</div>
      <div class="stat-label">–†–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤</div>
    </div>
    <div class="stat-item" th:if="${discountedProductsCount != null and discountedProductsCount > 0}">
      <div class="stat-value" th:text="${discountedProductsCount}">3</div>
      <div class="stat-label">–°–æ —Å–∫–∏–¥–∫–æ–π</div>
    </div>
  </div>

  <!-- –°–µ—Ç–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ -->
  <div th:if="${hasProducts}" class="products-grid">
    <div th:each="product : ${products}" class="product-card">
      <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ -->
      <div class="product-image-container">
        <img th:if="${product.picUrl != null and !#strings.isEmpty(product.picUrl)}"
             th:src="${product.picUrl}"
             th:alt="${product.name}"
             class="product-image"
             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
        <div th:unless="${product.picUrl != null and !#strings.isEmpty(product.picUrl)}"
             class="product-image-placeholder">
          <i class="fas fa-utensils"></i>
        </div>

        <!-- –ë–µ–π–¥–∂–∏ -->
        <div class="product-badges">
          <div th:if="${product.hasDiscount != null and product.hasDiscount}" class="badge badge-discount">
            <i class="fas fa-percent"></i> –°–∫–∏–¥–∫–∞
          </div>
          <div th:if="${product.isPopular != null and product.isPopular}" class="badge badge-popular">
            <i class="fas fa-fire"></i> –ü–æ–ø—É–ª—è—Ä–Ω–æ–µ
          </div>
        </div>
      </div>

      <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –ø—Ä–æ–¥—É–∫—Ç–∞ -->
      <div class="product-content">
        <h3 class="product-name" th:text="${product.name}">–ü–∏—Ü—Ü–∞ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞</h3>
        <p class="product-description" th:text="${product.description}">
          –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –ø–∏—Ü—Ü–∞ —Å —Ç–æ–º–∞—Ç–∞–º–∏ –∏ –º–æ—Ü–∞—Ä–µ–ª–ª–æ–π
        </p>

        <!-- –¶–µ–Ω—ã -->
        <div class="product-pricing">
          <div class="final-price" th:text="${product.finalPrice} + '‚ÇΩ'">450‚ÇΩ</div>
          <div th:if="${product.hasDiscount != null and product.hasDiscount}"
               class="original-price" th:text="${product.price} + '‚ÇΩ'">500‚ÇΩ</div>
          <div th:if="${product.hasDiscount != null and product.hasDiscount}"
               class="discount-amount"
               th:text="'-' + ${T(java.lang.Math).round((product.price.subtract(product.finalPrice)).doubleValue())} + '‚ÇΩ'">
            -50‚ÇΩ
          </div>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞–≥–∞–∑–∏–Ω–µ -->
        <div class="product-store" th:if="${product.storeId != null}">
          <i class="fas fa-store"></i>
          <span>ID –º–∞–≥–∞–∑–∏–Ω–∞: <span th:text="${product.storeId}">123</span></span>
        </div>

        <!-- –î–µ–π—Å—Ç–≤–∏—è -->
        <div class="product-actions">
          <button class="btn btn-primary add-to-cart"
                  th:data-product-id="${product.id}"
                  th:data-store-id="${product.storeId}"
                  th:disabled="${product.isAvailable != null and !product.isAvailable}">
            <i class="fas fa-plus"></i>
            <span th:if="${product.isAvailable == null or product.isAvailable}">–î–æ–±–∞–≤–∏—Ç—å</span>
            <span th:unless="${product.isAvailable == null or product.isAvailable}">–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ</span>
          </button>
          <a th:href="@{'/stores/' + ${product.storeId}}" class="btn btn-outline">
            <i class="fas fa-store"></i>
            –ö –º–∞–≥–∞–∑–∏–Ω—É
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
  <div th:if="${hasProducts and (hasNext or hasPrevious)}" class="pagination-container">
    <div class="pagination">
      <!-- –ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
      <a th:if="${hasPrevious}"
         th:href="@{'/categories/' + ${category.id} + '?page=' + ${previousPage} + '&size=' + ${pageSize} + (${sortBy} != null ? '&sortBy=' + ${sortBy} : '') + (${priceRange} != null ? '&priceRange=' + ${priceRange} : '')}"
         class="btn btn-outline">
        <i class="fas fa-chevron-left"></i>
        –ù–∞–∑–∞–¥
      </a>

      <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç—Ä–∞–Ω–∏—Ü–µ -->
      <div class="page-info">
        –°—Ç—Ä–∞–Ω–∏—Ü–∞ <strong th:text="${currentPage + 1}">1</strong>
        <span th:if="${totalCount != null and pageSize != null}">
                    –∏–∑ <strong th:text="${T(java.lang.Math).ceil(totalCount / pageSize)}">5</strong>
                </span>
      </div>

      <!-- –°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
      <a th:if="${hasNext}"
         th:href="@{'/categories/' + ${category.id} + '?page=' + ${nextPage} + '&size=' + ${pageSize} + (${sortBy} != null ? '&sortBy=' + ${sortBy} : '') + (${priceRange} != null ? '&priceRange=' + ${priceRange} : '')}"
         class="btn btn-primary">
        –î–∞–ª–µ–µ
        <i class="fas fa-chevron-right"></i>
      </a>
    </div>
  </div>

  <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
  <div th:if="${categoryFound and !hasProducts}" class="empty-state">
    <div class="empty-icon">
      <i class="fas fa-box-open"></i>
    </div>
    <h2 class="empty-title">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h2>
    <p class="empty-description">
      –í –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ <strong th:text="${category.name}">—ç—Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è</strong> –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤.
      <span th:if="${message}" th:text="${message}">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</span>
    </p>
    <div class="empty-actions">
      <a href="/stores" class="btn btn-primary">
        <i class="fas fa-store"></i>
        –°–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã
      </a>
      <a href="/categories" class="btn btn-outline">
        <i class="fas fa-arrow-left"></i>
        –ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
      </a>
    </div>
  </div>

  <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ -->
  <div th:unless="${categoryFound}" class="empty-state">
    <div class="empty-icon">
      <i class="fas fa-search"></i>
    </div>
    <h2 class="empty-title">–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</h2>
    <p class="empty-description">
      –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞.
      –í–µ—Ä–Ω–∏—Ç–µ—Å—å –∫ —Å–ø–∏—Å–∫—É –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π.
    </p>
    <div class="empty-actions">
      <a href="/categories" class="btn btn-primary">
        <i class="fas fa-utensils"></i>
        –í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
      </a>
      <a href="/" class="btn btn-outline">
        <i class="fas fa-home"></i>
        –ù–∞ –≥–ª–∞–≤–Ω—É—é
      </a>
    </div>
  </div>
</div>

<script src="/js/store/addToCart.js"></script>
<script>
  // ‚úÖ –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏–∑ Thymeleaf
  const isAuthenticated = [[${isAuthenticated}]];
  const jwtToken = '[[${jwtToken}]]';
  const categoryId = [[${category != null ? category.id : null}]];

  console.log('üóÇÔ∏è Category Products Page Debug:');
  console.log('- Is Authenticated:', isAuthenticated);
  console.log('- Category ID:', categoryId);
  console.log('- Has Products:', [[${hasProducts}]]);

  // ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–æ–¥—É–ª—å –∫–æ—Ä–∑–∏–Ω—ã —Å –¥–∞–Ω–Ω—ã–º–∏
  if (typeof initCartModule === 'function') {
    initCartModule(isAuthenticated, jwtToken);
  }

  // ‚úÖ –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
  function updateFilters() {
    const sortBy = document.getElementById('sortBy').value;
    const priceRange = document.getElementById('priceRange').value;

    const params = new URLSearchParams();
    params.set('page', '0');
    params.set('size', '20');

    if (sortBy) params.set('sortBy', sortBy);
    if (priceRange) params.set('priceRange', priceRange);

    window.location.href = `/categories/${categoryId}?${params.toString()}`;
  }

  // ‚úÖ –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–µ—Å–ª–∏ –Ω–µ—Ç –≤ addToCart.js)
  function showNotification(message, type = 'info') {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ addToCart.js –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º —Å–≤–æ—é
    if (typeof showCartNotification === 'function') {
      showCartNotification(message, type);
    } else {
      // Fallback —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      alert(message);
    }
  }

  // ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  document.addEventListener('DOMContentLoaded', function() {
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É"
    const addToCartButtons = document.querySelectorAll('.add-to-cart');
    addToCartButtons.forEach(button => {
      const productId = button.getAttribute('data-product-id');
      const storeId = button.getAttribute('data-store-id');

      if (productId && storeId) {
        button.addEventListener('click', function(e) {
          e.preventDefault();
          if (!this.disabled && typeof addToCart === 'function') {
            addToCart(parseInt(productId), parseInt(storeId));
          }
        });
      }
    });

    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
    const productCards = document.querySelectorAll('.product-card');
    productCards.forEach((card, index) => {
      card.style.opacity = '0';
      card.style.transform = 'translateY(30px)';
      setTimeout(() => {
        card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        card.style.opacity = '1';
        card.style.transform = 'translateY(0)';
      }, index * 150);
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    const images = document.querySelectorAll('.product-image');
    images.forEach(img => {
      img.addEventListener('error', function() {
        this.style.display = 'none';
        const placeholder = this.nextElementSibling;
        if (placeholder && placeholder.classList.contains('product-image-placeholder')) {
          placeholder.style.display = 'flex';
        }
      });
    });

    // –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
    const messages = document.querySelectorAll('.message');
    messages.forEach(message => {
      setTimeout(() => {
        message.style.opacity = '0';
        setTimeout(() => {
          if (message.parentElement) {
            message.remove();
          }
        }, 300);
      }, 5000);
    });

    // –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    const animatedElements = document.querySelectorAll('.category-header, .filters-section, .products-stats');
    animatedElements.forEach((element, index) => {
      element.style.opacity = '0';
      element.style.transform = 'translateY(20px)';
      setTimeout(() => {
        element.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
        element.style.opacity = '1';
        element.style.transform = 'translateY(0)';
      }, index * 200);
    });

    console.log('‚úÖ Category products page initialized');
  });
</script>

<script src="/js/bolt-navigation.js"></script>
</body>
</html>