<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QuickFood - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</title>
  <link rel="stylesheet" href="/css/register.css">
</head>
<body>
<div class="floating-shapes">
  <div class="shape"></div>
  <div class="shape"></div>
  <div class="shape"></div>
</div>

<div class="register-container">
  <div class="logo">
    <div class="logo-icon"></div>
    <h1>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
    <p>–°–æ–∑–¥–∞–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –≤ QuickFood</p>
  </div>

  <!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö/—É—Å–ø–µ—Ö–µ -->
  <div th:if="${error}" class="error-message" th:text="${error}"></div>
  <div th:if="${success}" class="success-message" th:text="${success}"></div>

  <form id="registrationForm" th:action="@{/register}" method="post" th:object="${registrationDto}">

    <!-- –ò–º—è -->
    <div class="form-group">
      <label for="firstName">–ò–º—è <span class="required">*</span></label>
      <input
              type="text"
              id="firstName"
              th:field="*{firstName}"
              placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è"
              required
      >
      <div th:if="${#fields.hasErrors('firstName')}" class="field-error" th:errors="*{firstName}"></div>
    </div>

    <!-- –§–∞–º–∏–ª–∏—è -->
    <div class="form-group">
      <label for="lastName">–§–∞–º–∏–ª–∏—è <span class="required">*</span></label>
      <input
              type="text"
              id="lastName"
              th:field="*{lastName}"
              placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É —Ñ–∞–º–∏–ª–∏—é"
              required
      >
      <div th:if="${#fields.hasErrors('lastName')}" class="field-error" th:errors="*{lastName}"></div>
    </div>

    <!-- Email -->
    <div class="form-group">
      <label for="email">Email <span class="required">*</span></label>
      <div class="input-wrapper">
        <input
                type="email"
                id="email"
                th:field="*{email}"
                placeholder="example@mail.com"
                required
        >
        <span id="emailStatus" class="email-status"></span>
      </div>
      <div th:if="${#fields.hasErrors('email')}" class="field-error" th:errors="*{email}"></div>
    </div>

    <!-- –ü–∞—Ä–æ–ª—å -->
    <div class="form-group">
      <label for="password">–ü–∞—Ä–æ–ª—å <span class="required">*</span></label>
      <div class="input-wrapper">
        <input
                type="password"
                id="password"
                th:field="*{password}"
                placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤"
                required
                minlength="6"
        >
        <button type="button" class="password-toggle" onclick="togglePassword()">
          üëÅÔ∏è
        </button>
      </div>
      <div th:if="${#fields.hasErrors('password')}" class="field-error" th:errors="*{password}"></div>
    </div>

    <!-- –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div class="form-group">
      <label>–Ø —Ö–æ—á—É <span class="required">*</span></label>
      <div class="role-grid">
        <div class="role-option" th:each="role : ${availableRoles}">
          <input
                  type="radio"
                  th:id="'role_' + ${role.name()}"
                  th:field="*{userRole}"
                  th:value="${role}"
                  required
          >
          <label th:for="'role_' + ${role.name()}" class="role-label">
                            <span class="role-icon" th:switch="${role.name()}">
                                <span th:case="'BASE_USER'">üõí</span>
                                <span th:case="'BUSINESS_USER'">üè™</span>
                                <span th:case="'COURIER'">üöö</span>
                                <span th:case="*">üë§</span>
                            </span>
            <div class="role-name" th:text="${role.displayName}">–†–æ–ª—å</div>
          </label>
        </div>
      </div>
      <div th:if="${#fields.hasErrors('userRole')}" class="field-error" th:errors="*{userRole}"></div>
    </div>

    <button type="submit" class="register-btn" id="registerBtn">
      <span class="loading-spinner" id="loadingSpinner"></span>
      <span id="btnText">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</span>
    </button>
  </form>

  <div class="links">
    <a href="/login">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</a>
  </div>
</div>

<script>
  let emailCheckTimeout;

  function togglePassword() {
    const passwordInput = document.getElementById('password');
    const toggleBtn = document.querySelector('.password-toggle');

    if (passwordInput.type === 'password') {
      passwordInput.type = 'text';
      toggleBtn.textContent = 'üôà';
    } else {
      passwordInput.type = 'password';
      toggleBtn.textContent = 'üëÅÔ∏è';
    }
  }

  function setLoading(loading) {
    const registerBtn = document.getElementById('registerBtn');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const btnText = document.getElementById('btnText');

    if (loading) {
      registerBtn.disabled = true;
      loadingSpinner.style.display = 'inline-block';
      btnText.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞...';
    } else {
      registerBtn.disabled = false;
      loadingSpinner.style.display = 'none';
      btnText.textContent = '–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç';
    }
  }

  function setEmailStatus(status, message) {
    const emailStatus = document.getElementById('emailStatus');
    emailStatus.className = `email-status email-${status}`;

    switch(status) {
      case 'checking':
        emailStatus.textContent = '‚è≥';
        emailStatus.title = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
        break;
      case 'available':
        emailStatus.textContent = '‚úÖ';
        emailStatus.title = 'Email –¥–æ—Å—Ç—É–ø–µ–Ω';
        break;
      case 'taken':
        emailStatus.textContent = '‚ùå';
        emailStatus.title = 'Email —É–∂–µ –∑–∞–Ω—è—Ç';
        break;
      default:
        emailStatus.textContent = '';
        emailStatus.title = '';
    }
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ email
  function checkEmailAvailability(email) {
    if (!email || email.length < 3) {
      setEmailStatus('', '');
      return;
    }

    setEmailStatus('checking', '–ü—Ä–æ–≤–µ—Ä–∫–∞...');

    fetch(`/register/check-email?email=${encodeURIComponent(email)}`)
            .then(response => response.json())
            .then(isAvailable => {
              if (isAvailable) {
                setEmailStatus('available', 'Email –¥–æ—Å—Ç—É–ø–µ–Ω');
              } else {
                setEmailStatus('taken', 'Email —É–∂–µ –∑–∞–Ω—è—Ç');
              }
            })
            .catch(error => {
              console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ email:', error);
              setEmailStatus('', '');
            });
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è email
  document.getElementById('email').addEventListener('input', function(e) {
    const email = e.target.value;

    clearTimeout(emailCheckTimeout);
    emailCheckTimeout = setTimeout(() => {
      checkEmailAvailability(email);
    }, 500);
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
  document.getElementById('registrationForm').addEventListener('submit', function(e) {
    const emailStatus = document.getElementById('emailStatus');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ email –¥–æ—Å—Ç—É–ø–µ–Ω
    if (emailStatus.classList.contains('email-taken')) {
      e.preventDefault();
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π email –∞–¥—Ä–µ—Å');
      return false;
    }

    setLoading(true);
  });

  // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ –ø–æ–ª—è
  document.querySelectorAll('input, select').forEach(input => {
    input.addEventListener('focus', function() {
      const formGroup = this.closest('.form-group');
      if (formGroup) {
        formGroup.style.transform = 'scale(1.02)';
        formGroup.style.transition = 'transform 0.2s ease';
      }
    });

    input.addEventListener('blur', function() {
      const formGroup = this.closest('.form-group');
      if (formGroup) {
        formGroup.style.transform = 'scale(1)';
      }
    });
  });

  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('from') === 'login') {
    console.log('üîÑ –ü–µ—Ä–µ—Ö–æ–¥ —Å —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤—Ö–æ–¥–∞');
  }
</script>
</body>
</html>