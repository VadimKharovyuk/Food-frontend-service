<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="auth-token" th:content="${authToken}">
  <meta name="auth-header" th:content="${authHeader}">
  <meta name="is-authenticated" th:content="${isAuthenticated}">
  <title>–î–æ—Å—Ç–∞–≤–∫–∞ –µ–¥—ã - –†–µ—Å—Ç–æ—Ä–∞–Ω—ã —Ä—è–¥–æ–º</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <link rel="stylesheet" href="/css/bolt-navigation.css">
  <link rel="stylesheet" href="/css/stores/store-list.css">
</head>
<body>
<!-- Header -->
<div th:replace="~{fragments/navigation :: navigation}"></div>


<div class="container">
  <!-- Search Hero -->
  <div class="search-hero">
    <div class="text-center mb-3">
      <h2 class="text-dark mb-2">üçï –ù–∞–π–¥–∏—Ç–µ —Å–≤–æ–π –ª—é–±–∏–º—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω</h2>
      <p class="text-muted">–ë—ã—Å—Ç—Ä–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –∏–∑ –ª—É—á—à–∏—Ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ –≥–æ—Ä–æ–¥–∞</p>
    </div>
    <form class="search-form" method="GET" action="/">
      <input type="text"
             class="form-control search-input"
             name="search"
             th:value="${search}"
             placeholder="–ü–æ–∏—Å–∫ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤, –∫—É—Ö–Ω–∏, –±–ª—é–¥...">
      <button type="submit" class="btn btn-search">
        <i class="fas fa-search me-1"></i>
        –ù–∞–π—Ç–∏
      </button>
    </form>
  </div>

  <!-- Filters Bar -->
  <div class="filters-bar">
    <div class="filter-chips">
      <span class="fw-bold text-dark me-2">–§–∏–ª—å—Ç—Ä—ã:</span>
      <a href="/?sortBy=rating" class="filter-chip" th:classappend="${sortBy == 'rating'} ? 'active' : ''">
        <i class="fas fa-star me-1"></i>
        –ü–æ —Ä–µ–π—Ç–∏–Ω–≥—É
      </a>
      <a href="/?sortBy=delivery_time" class="filter-chip" th:classappend="${sortBy == 'delivery_time'} ? 'active' : ''">
        <i class="fas fa-clock me-1"></i>
        –ë—ã—Å—Ç—Ä–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞
      </a>
      <a href="/?sortBy=delivery_fee" class="filter-chip" th:classappend="${sortBy == 'delivery_fee'} ? 'active' : ''">
        <i class="fas fa-dollar-sign me-1"></i>
        –ù–∏–∑–∫–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å
      </a>
      <a href="/?sortBy=popular" class="filter-chip" th:classappend="${sortBy == 'popular'} ? 'active' : ''">
        <i class="fas fa-fire me-1"></i>
        –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ
      </a>
    </div>
  </div>

  <!-- Stats Bar -->
  <div class="stats-bar" th:if="${stores != null and !stores.empty}">
    <div class="stats-info">
      –ù–∞–π–¥–µ–Ω–æ <span class="results-count" th:text="${totalCount}">0</span> —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤
    </div>
    <div class="stats-info">
      –°—Ç—Ä–∞–Ω–∏—Ü–∞ <span th:text="${currentPage + 1}">1</span> –∏–∑ <span th:text="${totalPages}">1</span>
    </div>
  </div>

  <!-- Stores Grid -->
  <div class="stores-grid" th:if="${stores != null and !stores.empty}">
    <div th:each="store : ${stores}" class="store-card">
      <!-- Store Status -->
      <div th:class="${store.isActive} ? 'store-status' : 'store-status closed'"
           th:text="${store.isActive} ? '–û—Ç–∫—Ä—ã—Ç' : '–ó–∞–∫—Ä—ã—Ç'">
        –û—Ç–∫—Ä—ã—Ç
      </div>

      <!-- Store Image -->
      <div th:if="${store.picUrl != null and !store.picUrl.isEmpty()}">
        <img th:src="${store.picUrl}"
             th:alt="${store.name}"
             class="store-image"
             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
        <div class="store-image-placeholder" style="display: none;">
          <div class="placeholder-icon">
            <i class="fas fa-utensils"></i>
            <div class="placeholder-text" th:text="${store.name}">–§–æ—Ç–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</div>
          </div>
        </div>
      </div>
      <div th:if="${store.picUrl == null or store.picUrl.isEmpty()}" class="store-image-placeholder">
        <div class="placeholder-icon">
          <i class="fas fa-utensils"></i>
          <div class="placeholder-text" th:text="${store.name}">–§–æ—Ç–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</div>
        </div>
      </div>

      <!-- Store Content -->
      <div class="store-content">
        <!-- Store Header -->
        <div class="store-header">
          <h5 class="store-name" th:text="${store.name}">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</h5>
          <button th:if="${isAuthenticated}"
                  class="favorite-btn"
                  th:classappend="${favoriteStoreIds.contains(store.id)} ? 'active' : ''"
                  th:onclick="|toggleFavorite(${store.id})|">
            <i th:class="${favoriteStoreIds.contains(store.id)} ? 'fas fa-heart' : 'far fa-heart'"></i>
          </button>
        </div>

        <!-- Rating -->
        <div class="store-rating" th:if="${store.rating != null}">
          <div class="rating-stars">
            <i class="fas fa-star" th:if="${store.rating >= 1}"></i>
            <i class="fas fa-star" th:if="${store.rating >= 2}"></i>
            <i class="fas fa-star" th:if="${store.rating >= 3}"></i>
            <i class="fas fa-star" th:if="${store.rating >= 4}"></i>
            <i class="fas fa-star" th:if="${store.rating >= 5}"></i>
          </div>
          <span class="rating-value" th:text="${store.rating}">4.5</span>
          <span class="text-muted">(120+ –æ—Ç–∑—ã–≤–æ–≤)</span>
        </div>

        <!-- Store Info -->
        <div class="store-info">
          <div class="delivery-time">
            <i class="fas fa-clock"></i>
            <span th:text="${store.estimatedDeliveryTime} + ' –º–∏–Ω'">30 –º–∏–Ω</span>
          </div>
          <div class="delivery-fee" th:if="${store.deliveryFee != null and store.deliveryFee > 0}">
            <span th:text="${store.deliveryFee} + ' ‚ÇΩ'">100 ‚ÇΩ</span>
          </div>
          <div class="delivery-fee" th:if="${store.deliveryFee != null and store.deliveryFee == 0}">
            –ë–µ—Å–ø–ª–∞—Ç–Ω–æ
          </div>
        </div>

        <!-- Address -->
        <div class="store-address" th:if="${store.addressStreet}">
          <i class="fas fa-map-marker-alt"></i>
          <span th:text="${store.addressStreet + ', ' + store.addressCity}">–ê–¥—Ä–µ—Å —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</span>
        </div>

        <!-- Order Button -->
        <button class="order-btn"
                th:disabled="${!store.isActive}"
                th:onclick="|window.location.href='/stores/${store.id}'|">
          <i class="fas fa-shopping-cart me-1"></i>
          <span th:if="${store.isActive}">–ó–∞–∫–∞–∑–∞—Ç—å</span>
          <span th:unless="${store.isActive}">–ó–∞–∫—Ä—ã—Ç</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div th:if="${stores == null or stores.empty}" class="empty-state">
    <i class="fas fa-search"></i>
    <h3>–†–µ—Å—Ç–æ—Ä–∞–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
    <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π –≥–æ—Ä–æ–¥</p>
    <a href="/" class="btn btn-primary">
      <i class="fas fa-home me-1"></i>
      –ù–∞ –≥–ª–∞–≤–Ω—É—é
    </a>
  </div>

  <!-- Pagination -->
  <div class="pagination-container" th:if="${totalPages > 1}">
    <nav>
      <ul class="pagination">
        <!-- Previous -->
        <li class="page-item" th:classappend="${!hasPrevious} ? 'disabled' : ''">
          <a class="page-link"
             th:href="${hasPrevious} ? ('/?page=' + ${previousPage} + '&size=' + ${pageSize} + (${search} != null ? ('&search=' + ${search}) : '') + (${city} != null ? ('&city=' + ${city}) : '') + (${sortBy} != null ? ('&sortBy=' + ${sortBy}) : '')) : '#'"
             th:attr="aria-disabled=${!hasPrevious}">
            <i class="fas fa-chevron-left"></i>
          </a>
        </li>

        <!-- Page Numbers -->
        <li class="page-item"
            th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}"
            th:classappend="${pageNum == currentPage} ? 'active' : ''">
          <a class="page-link"
             th:href="'/?page=' + ${pageNum} + '&size=' + ${pageSize} + (${search} != null ? ('&search=' + ${search}) : '') + (${city} != null ? ('&city=' + ${city}) : '') + (${sortBy} != null ? ('&sortBy=' + ${sortBy}) : '')"
             th:text="${pageNum + 1}">1</a>
        </li>

        <!-- Next -->
        <li class="page-item" th:classappend="${!hasNext} ? 'disabled' : ''">
          <a class="page-link"
             th:href="${hasNext} ? ('/?page=' + ${nextPage} + '&size=' + ${pageSize} + (${search} != null ? ('&search=' + ${search}) : '') + (${city} != null ? ('&city=' + ${city}) : '') + (${sortBy} != null ? ('&sortBy=' + ${sortBy}) : '')) : '#'"
             th:attr="aria-disabled=${!hasNext}">
            <i class="fas fa-chevron-right"></i>
          </a>
        </li>
      </ul>
    </nav>
  </div>
</div>
<script src="/js/bolt-navigation.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script>
  // Toggle Favorite Function
  function toggleFavorite(storeId) {
    console.log(`üîÑ Toggling favorite for store ${storeId}`);

    if (!isUserAuthenticated()) {
      showNotification('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ', 'error');
      return;
    }

    const authHeader = getAuthHeader();
    if (!authHeader) {
      showNotification('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –í–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.', 'error');
      return;
    }

    console.log('üîê Using auth header for favorite toggle');

    fetch(`/api/stores/${storeId}/toggle-favorite`, {
      method: 'POST',
      headers: {
        'Authorization': authHeader,
        'Content-Type': 'application/json'
      }
    })
            .then(response => {
              console.log(`üì° Response status: ${response.status}`);
              return response.json();
            })
            .then(data => {
              console.log('üì¶ Response data:', data);

              if (data.success) {
                // Find the button and update it
                const buttons = document.querySelectorAll(`[onclick*="toggleFavorite(${storeId})"]`);
                buttons.forEach(btn => {
                  const icon = btn.querySelector('i');

                  if (data.isFavorite) {
                    btn.classList.add('active');
                    if (icon) icon.className = 'fas fa-heart';
                  } else {
                    btn.classList.remove('active');
                    if (icon) icon.className = 'far fa-heart';
                  }
                });

                showNotification(data.message || '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
              } else {
                showNotification(data.message || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ', 'error');
              }
            })
            .catch(error => {
              console.error('üí• Error toggling favorite:', error);
              showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ', 'error');
            });
  }

  // Enhanced auth token management
  function getAuthToken() {
    // 1. Try to get from meta tag (preferred method)
    const metaToken = document.querySelector('meta[name="auth-token"]');
    if (metaToken && metaToken.getAttribute('content')) {
      const token = metaToken.getAttribute('content').trim();
      if (token && token !== '') {
        console.log('‚úÖ Token found in meta tag');
        return token;
      }
    }

    // 2. Try to get from localStorage
    const localToken = localStorage.getItem('authToken');
    if (localToken) {
      console.log('‚úÖ Token found in localStorage');
      return localToken;
    }

    // 3. Try to get from sessionStorage
    const sessionToken = sessionStorage.getItem('authToken');
    if (sessionToken) {
      console.log('‚úÖ Token found in sessionStorage');
      return sessionToken;
    }

    // 4. Try to get from cookie
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      const [name, value] = cookie.trim().split('=');
      if (name === 'authToken' && value) {
        console.log('‚úÖ Token found in cookie');
        return value;
      }
    }

    console.warn('‚ö†Ô∏è No auth token found');
    return null;
  }

  function getAuthHeader() {
    // 1. Try to get full header from meta tag
    const metaHeader = document.querySelector('meta[name="auth-header"]');
    if (metaHeader && metaHeader.getAttribute('content')) {
      const header = metaHeader.getAttribute('content').trim();
      if (header && header !== '' && header.startsWith('Bearer ')) {
        return header;
      }
    }

    // 2. Construct from token
    const token = getAuthToken();
    if (token) {
      return `Bearer ${token}`;
    }

    return null;
  }

  function isUserAuthenticated() {
    const metaAuth = document.querySelector('meta[name="is-authenticated"]');
    if (metaAuth) {
      return metaAuth.getAttribute('content') === 'true';
    }

    return getAuthToken() !== null;
  }

  // Show notification
  function showNotification(message, type) {
    // Simple notification implementation
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
    notification.textContent = message;

    document.body.appendChild(notification);

    setTimeout(() => {
      notification.remove();
    }, 3000);
  }

  // Debug information on page load
  document.addEventListener('DOMContentLoaded', function() {
    console.log('üîç Auth Debug Info:');
    console.log('- Is Authenticated:', isUserAuthenticated());
    console.log('- Auth Token:', getAuthToken() ? 'Present' : 'Missing');
    console.log('- Auth Header:', getAuthHeader() ? 'Present' : 'Missing');

    // Store card animations and hover effects
    const storeCards = document.querySelectorAll('.store-card');
    storeCards.forEach((card, index) => {
      // Stagger animation
      card.style.animationDelay = `${index * 0.1}s`;

      // Enhanced hover effects
      card.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-8px) scale(1.02)';
        this.style.boxShadow = 'var(--shadow-hover)';
      });

      card.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0) scale(1)';
        this.style.boxShadow = 'var(--shadow)';
      });
    });

    // Image error handling
    const images = document.querySelectorAll('.store-image');
    images.forEach((img) => {
      img.addEventListener('error', function() {
        console.log('Image failed to load:', this.src);
        this.style.display = 'none';
        const placeholder = this.nextElementSibling;
        if (placeholder && placeholder.classList.contains('store-image-placeholder')) {
          placeholder.style.display = 'flex';
        }
      });

      img.addEventListener('load', function() {
        console.log('Image loaded successfully:', this.src);
      });
    });

    // Enhanced search functionality
    const searchInput = document.querySelector('.search-input[name="search"]');
    if (searchInput) {
      let searchTimeout;
      searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          console.log('Search query:', this.value);
        }, 300);
      });
    }
  });

  // Search auto-complete (optional enhancement)
  const searchInput = document.querySelector('.search-input[name="search"]');
  if (searchInput) {
    let searchTimeout;
    searchInput.addEventListener('input', function() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        // Implement search suggestions if needed
      }, 300);
    });
  }
</script>
</body>
</html>