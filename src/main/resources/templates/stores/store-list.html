<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="auth-token" th:content="${authToken}">
  <meta name="auth-header" th:content="${authHeader}">
  <meta name="is-authenticated" th:content="${isAuthenticated}">
  <title>–î–æ—Å—Ç–∞–≤–∫–∞ –µ–¥—ã - –†–µ—Å—Ç–æ—Ä–∞–Ω—ã —Ä—è–¥–æ–º</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary-green: #00A651;
      --secondary-green: #4CAF50;
      --light-green: #E8F5E8;
      --dark-green: #2E7D31;
      --pure-white: #FFFFFF;
      --light-gray: #F8F9FA;
      --medium-gray: #6C757D;
      --dark-black: #212529;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.15);
      --border-radius: 16px;
    }

    body {
      background-color: var(--light-gray);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--dark-black);
    }

    /* Header */
    .delivery-header {
      background: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
      color: var(--pure-white);
      padding: 2rem 0;
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      font-size: 1.8rem;
      font-weight: 700;
      display: flex;
      align-items: center;
    }

    .logo i {
      margin-right: 0.5rem;
      font-size: 2rem;
    }

    .search-hero {
      background: var(--pure-white);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      margin: 2rem 0;
      box-shadow: var(--shadow);
    }

    .search-form {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .search-input {
      border: 2px solid #E9ECEF;
      border-radius: 12px;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      transition: all 0.3s ease;
      flex: 1;
    }

    .search-input:focus {
      border-color: var(--primary-green);
      box-shadow: 0 0 0 3px rgba(0, 166, 81, 0.1);
      outline: none;
    }

    .btn-search {
      background: var(--primary-green);
      border: none;
      color: var(--pure-white);
      padding: 0.75rem 1.5rem;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-search:hover {
      background: var(--dark-green);
      transform: translateY(-2px);
    }

    /* Store Cards */
    .stores-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 1.5rem;
      padding: 0;
    }

    .store-card {
      background: var(--pure-white);
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
      position: relative;
      border: none;
    }

    .store-card:hover {
      transform: translateY(-8px);
      box-shadow: var(--shadow-hover);
    }

    .store-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-bottom: 3px solid var(--light-green);
    }

    .store-image-placeholder {
      width: 100%;
      height: 200px;
      background: linear-gradient(135deg, var(--light-green), #f8f9fa);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      color: var(--primary-green);
      border-bottom: 3px solid var(--light-green);
      position: relative;
      overflow: hidden;
    }

    .store-image-placeholder::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    .store-image-placeholder .placeholder-icon {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      z-index: 1;
    }

    .store-image-placeholder .placeholder-text {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--medium-gray);
    }

    .store-content {
      padding: 1.5rem;
    }

    .store-header {
      display: flex;
      justify-content: between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }

    .store-name {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--dark-black);
      margin: 0;
      line-height: 1.3;
      flex: 1;
    }

    .favorite-btn {
      background: transparent;
      border: none;
      font-size: 1.5rem;
      color: var(--medium-gray);
      transition: all 0.3s ease;
      padding: 0.5rem;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .favorite-btn:hover {
      background: var(--light-green);
      color: var(--primary-green);
    }

    .favorite-btn.active {
      color: #DC3545;
      background: #FFF5F5;
    }

    .store-rating {
      display: flex;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .rating-stars {
      color: #FFB400;
      margin-right: 0.5rem;
    }

    .rating-value {
      font-weight: 600;
      color: var(--dark-black);
      margin-right: 0.5rem;
    }

    .store-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .delivery-time {
      background: var(--light-green);
      color: var(--dark-green);
      padding: 0.3rem 0.75rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      display: flex;
      align-items: center;
    }

    .delivery-time i {
      margin-right: 0.3rem;
    }

    .delivery-fee {
      background: var(--primary-green);
      color: var(--pure-white);
      padding: 0.3rem 0.75rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .store-address {
      color: var(--medium-gray);
      font-size: 0.9rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
    }

    .store-address i {
      margin-right: 0.5rem;
      color: var(--primary-green);
    }

    .store-status {
      position: absolute;
      top: 1rem;
      left: 1rem;
      background: var(--primary-green);
      color: var(--pure-white);
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .store-status.closed {
      background: var(--medium-gray);
    }

    .order-btn {
      width: 100%;
      background: var(--primary-green);
      border: none;
      color: var(--pure-white);
      padding: 0.75rem;
      border-radius: 12px;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .order-btn:hover {
      background: var(--dark-green);
      transform: translateY(-2px);
    }

    .order-btn:disabled {
      background: var(--medium-gray);
      cursor: not-allowed;
      transform: none;
    }

    /* Pagination */
    .pagination-container {
      margin: 3rem 0;
      display: flex;
      justify-content: center;
    }

    .pagination .page-link {
      border-radius: 12px;
      margin: 0 0.25rem;
      color: var(--primary-green);
      border: 2px solid #E9ECEF;
      padding: 0.75rem 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .pagination .page-item.active .page-link {
      background-color: var(--primary-green);
      border-color: var(--primary-green);
      color: var(--pure-white);
    }

    .pagination .page-link:hover {
      background-color: var(--light-green);
      border-color: var(--primary-green);
      color: var(--dark-green);
    }

    /* Filters */
    .filters-bar {
      background: var(--pure-white);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
    }

    .filter-chips {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .filter-chip {
      background: var(--light-gray);
      border: 2px solid #E9ECEF;
      color: var(--dark-black);
      padding: 0.5rem 1rem;
      border-radius: 25px;
      text-decoration: none;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .filter-chip:hover,
    .filter-chip.active {
      background: var(--primary-green);
      color: var(--pure-white);
      border-color: var(--primary-green);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--medium-gray);
    }

    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1rem;
      color: var(--primary-green);
      opacity: 0.5;
    }

    .empty-state h3 {
      color: var(--dark-black);
      margin-bottom: 1rem;
    }

    /* Stats Bar */
    .stats-bar {
      background: var(--pure-white);
      border-radius: var(--border-radius);
      padding: 1rem 1.5rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }

    .stats-info {
      color: var(--medium-gray);
      font-weight: 500;
    }

    .results-count {
      color: var(--primary-green);
      font-weight: 700;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .stores-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .search-form {
        flex-direction: column;
      }

      .header-content {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }

      .filter-chips {
        justify-content: center;
      }
    }

    /* Animations */
    .store-card {
      animation: fadeInUp 0.6s ease forwards;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .loading-shimmer {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }

    @keyframes loading {
      0% {
        background-position: 200% 0;
      }
      100% {
        background-position: -200% 0;
      }
    }
  </style>
</head>
<body>
<!-- Header -->

<!--<div th:replace="~{fragments/navigation :: navigation}"></div>-->

<div class="container">
  <!-- Search Hero -->
  <div class="search-hero">
    <div class="text-center mb-3">
      <h2 class="text-dark mb-2">üçï –ù–∞–π–¥–∏—Ç–µ —Å–≤–æ–π –ª—é–±–∏–º—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω</h2>
      <p class="text-muted">–ë—ã—Å—Ç—Ä–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –∏–∑ –ª—É—á—à–∏—Ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ –≥–æ—Ä–æ–¥–∞</p>
    </div>
    <form class="search-form" method="GET" action="/">
      <input type="text"
             class="form-control search-input"
             name="search"
             th:value="${search}"
             placeholder="–ü–æ–∏—Å–∫ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤, –∫—É—Ö–Ω–∏, –±–ª—é–¥...">
      <select class="form-select search-input" name="city" style="max-width: 200px;">
        <option value="">–í—Å–µ –≥–æ—Ä–æ–¥–∞</option>
        <option value="New York" th:selected="${city == 'New York'}">New York</option>
        <option value="Moscow" th:selected="${city == 'Moscow'}">–ú–æ—Å–∫–≤–∞</option>
      </select>
      <button type="submit" class="btn btn-search">
        <i class="fas fa-search me-1"></i>
        –ù–∞–π—Ç–∏
      </button>
    </form>
  </div>

  <!-- Filters Bar -->
  <div class="filters-bar">
    <div class="filter-chips">
      <span class="fw-bold text-dark me-2">–§–∏–ª—å—Ç—Ä—ã:</span>
      <a href="/?sortBy=rating" class="filter-chip" th:classappend="${sortBy == 'rating'} ? 'active' : ''">
        <i class="fas fa-star me-1"></i>
        –ü–æ —Ä–µ–π—Ç–∏–Ω–≥—É
      </a>
      <a href="/?sortBy=delivery_time" class="filter-chip" th:classappend="${sortBy == 'delivery_time'} ? 'active' : ''">
        <i class="fas fa-clock me-1"></i>
        –ë—ã—Å—Ç—Ä–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞
      </a>
      <a href="/?sortBy=delivery_fee" class="filter-chip" th:classappend="${sortBy == 'delivery_fee'} ? 'active' : ''">
        <i class="fas fa-dollar-sign me-1"></i>
        –ù–∏–∑–∫–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å
      </a>
      <a href="/?sortBy=popular" class="filter-chip" th:classappend="${sortBy == 'popular'} ? 'active' : ''">
        <i class="fas fa-fire me-1"></i>
        –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ
      </a>
    </div>
  </div>

  <!-- Stats Bar -->
  <div class="stats-bar" th:if="${stores != null and !stores.empty}">
    <div class="stats-info">
      –ù–∞–π–¥–µ–Ω–æ <span class="results-count" th:text="${totalCount}">0</span> —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤
    </div>
    <div class="stats-info">
      –°—Ç—Ä–∞–Ω–∏—Ü–∞ <span th:text="${currentPage + 1}">1</span> –∏–∑ <span th:text="${totalPages}">1</span>
    </div>
  </div>

  <!-- Stores Grid -->
  <div class="stores-grid" th:if="${stores != null and !stores.empty}">
    <div th:each="store : ${stores}" class="store-card">
      <!-- Store Status -->
      <div th:class="${store.isActive} ? 'store-status' : 'store-status closed'"
           th:text="${store.isActive} ? '–û—Ç–∫—Ä—ã—Ç' : '–ó–∞–∫—Ä—ã—Ç'">
        –û—Ç–∫—Ä—ã—Ç
      </div>

      <!-- Store Image -->
      <div th:if="${store.picUrl != null and !store.picUrl.isEmpty()}">
        <img th:src="${store.picUrl}"
             th:alt="${store.name}"
             class="store-image"
             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
        <div class="store-image-placeholder" style="display: none;">
          <div class="placeholder-icon">
            <i class="fas fa-utensils"></i>
            <div class="placeholder-text" th:text="${store.name}">–§–æ—Ç–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</div>
          </div>
        </div>
      </div>
      <div th:if="${store.picUrl == null or store.picUrl.isEmpty()}" class="store-image-placeholder">
        <div class="placeholder-icon">
          <i class="fas fa-utensils"></i>
          <div class="placeholder-text" th:text="${store.name}">–§–æ—Ç–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</div>
        </div>
      </div>

      <!-- Store Content -->
      <div class="store-content">
        <!-- Store Header -->
        <div class="store-header">
          <h5 class="store-name" th:text="${store.name}">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</h5>
          <button th:if="${isAuthenticated}"
                  class="favorite-btn"
                  th:classappend="${favoriteStoreIds.contains(store.id)} ? 'active' : ''"
                  th:onclick="|toggleFavorite(${store.id})|">
            <i th:class="${favoriteStoreIds.contains(store.id)} ? 'fas fa-heart' : 'far fa-heart'"></i>
          </button>
        </div>

        <!-- Rating -->
        <div class="store-rating" th:if="${store.rating != null}">
          <div class="rating-stars">
            <i class="fas fa-star" th:if="${store.rating >= 1}"></i>
            <i class="fas fa-star" th:if="${store.rating >= 2}"></i>
            <i class="fas fa-star" th:if="${store.rating >= 3}"></i>
            <i class="fas fa-star" th:if="${store.rating >= 4}"></i>
            <i class="fas fa-star" th:if="${store.rating >= 5}"></i>
          </div>
          <span class="rating-value" th:text="${store.rating}">4.5</span>
          <span class="text-muted">(120+ –æ—Ç–∑—ã–≤–æ–≤)</span>
        </div>

        <!-- Store Info -->
        <div class="store-info">
          <div class="delivery-time">
            <i class="fas fa-clock"></i>
            <span th:text="${store.estimatedDeliveryTime} + ' –º–∏–Ω'">30 –º–∏–Ω</span>
          </div>
          <div class="delivery-fee" th:if="${store.deliveryFee != null and store.deliveryFee > 0}">
            <span th:text="${store.deliveryFee} + ' ‚ÇΩ'">100 ‚ÇΩ</span>
          </div>
          <div class="delivery-fee" th:if="${store.deliveryFee != null and store.deliveryFee == 0}">
            –ë–µ—Å–ø–ª–∞—Ç–Ω–æ
          </div>
        </div>

        <!-- Address -->
        <div class="store-address" th:if="${store.addressStreet}">
          <i class="fas fa-map-marker-alt"></i>
          <span th:text="${store.addressStreet + ', ' + store.addressCity}">–ê–¥—Ä–µ—Å —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</span>
        </div>

        <!-- Order Button -->
        <button class="order-btn"
                th:disabled="${!store.isActive}"
                th:onclick="|window.location.href='/stores/${store.id}'|">
          <i class="fas fa-shopping-cart me-1"></i>
          <span th:if="${store.isActive}">–ó–∞–∫–∞–∑–∞—Ç—å</span>
          <span th:unless="${store.isActive}">–ó–∞–∫—Ä—ã—Ç</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div th:if="${stores == null or stores.empty}" class="empty-state">
    <i class="fas fa-search"></i>
    <h3>–†–µ—Å—Ç–æ—Ä–∞–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
    <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π –≥–æ—Ä–æ–¥</p>
    <a href="/" class="btn btn-primary">
      <i class="fas fa-home me-1"></i>
      –ù–∞ –≥–ª–∞–≤–Ω—É—é
    </a>
  </div>

  <!-- Pagination -->
  <div class="pagination-container" th:if="${totalPages > 1}">
    <nav>
      <ul class="pagination">
        <!-- Previous -->
        <li class="page-item" th:classappend="${!hasPrevious} ? 'disabled' : ''">
          <a class="page-link"
             th:href="${hasPrevious} ? ('/?page=' + ${previousPage} + '&size=' + ${pageSize} + (${search} != null ? ('&search=' + ${search}) : '') + (${city} != null ? ('&city=' + ${city}) : '') + (${sortBy} != null ? ('&sortBy=' + ${sortBy}) : '')) : '#'"
             th:attr="aria-disabled=${!hasPrevious}">
            <i class="fas fa-chevron-left"></i>
          </a>
        </li>

        <!-- Page Numbers -->
        <li class="page-item"
            th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}"
            th:classappend="${pageNum == currentPage} ? 'active' : ''">
          <a class="page-link"
             th:href="'/?page=' + ${pageNum} + '&size=' + ${pageSize} + (${search} != null ? ('&search=' + ${search}) : '') + (${city} != null ? ('&city=' + ${city}) : '') + (${sortBy} != null ? ('&sortBy=' + ${sortBy}) : '')"
             th:text="${pageNum + 1}">1</a>
        </li>

        <!-- Next -->
        <li class="page-item" th:classappend="${!hasNext} ? 'disabled' : ''">
          <a class="page-link"
             th:href="${hasNext} ? ('/?page=' + ${nextPage} + '&size=' + ${pageSize} + (${search} != null ? ('&search=' + ${search}) : '') + (${city} != null ? ('&city=' + ${city}) : '') + (${sortBy} != null ? ('&sortBy=' + ${sortBy}) : '')) : '#'"
             th:attr="aria-disabled=${!hasNext}">
            <i class="fas fa-chevron-right"></i>
          </a>
        </li>
      </ul>
    </nav>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script>
  // Toggle Favorite Function
  function toggleFavorite(storeId) {
    console.log(`üîÑ Toggling favorite for store ${storeId}`);

    if (!isUserAuthenticated()) {
      showNotification('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ', 'error');
      return;
    }

    const authHeader = getAuthHeader();
    if (!authHeader) {
      showNotification('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –í–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.', 'error');
      return;
    }

    console.log('üîê Using auth header for favorite toggle');

    fetch(`/api/stores/${storeId}/toggle-favorite`, {
      method: 'POST',
      headers: {
        'Authorization': authHeader,
        'Content-Type': 'application/json'
      }
    })
            .then(response => {
              console.log(`üì° Response status: ${response.status}`);
              return response.json();
            })
            .then(data => {
              console.log('üì¶ Response data:', data);

              if (data.success) {
                // Find the button and update it
                const buttons = document.querySelectorAll(`[onclick*="toggleFavorite(${storeId})"]`);
                buttons.forEach(btn => {
                  const icon = btn.querySelector('i');

                  if (data.isFavorite) {
                    btn.classList.add('active');
                    if (icon) icon.className = 'fas fa-heart';
                  } else {
                    btn.classList.remove('active');
                    if (icon) icon.className = 'far fa-heart';
                  }
                });

                showNotification(data.message || '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
              } else {
                showNotification(data.message || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ', 'error');
              }
            })
            .catch(error => {
              console.error('üí• Error toggling favorite:', error);
              showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ', 'error');
            });
  }

  // Enhanced auth token management
  function getAuthToken() {
    // 1. Try to get from meta tag (preferred method)
    const metaToken = document.querySelector('meta[name="auth-token"]');
    if (metaToken && metaToken.getAttribute('content')) {
      const token = metaToken.getAttribute('content').trim();
      if (token && token !== '') {
        console.log('‚úÖ Token found in meta tag');
        return token;
      }
    }

    // 2. Try to get from localStorage
    const localToken = localStorage.getItem('authToken');
    if (localToken) {
      console.log('‚úÖ Token found in localStorage');
      return localToken;
    }

    // 3. Try to get from sessionStorage
    const sessionToken = sessionStorage.getItem('authToken');
    if (sessionToken) {
      console.log('‚úÖ Token found in sessionStorage');
      return sessionToken;
    }

    // 4. Try to get from cookie
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      const [name, value] = cookie.trim().split('=');
      if (name === 'authToken' && value) {
        console.log('‚úÖ Token found in cookie');
        return value;
      }
    }

    console.warn('‚ö†Ô∏è No auth token found');
    return null;
  }

  function getAuthHeader() {
    // 1. Try to get full header from meta tag
    const metaHeader = document.querySelector('meta[name="auth-header"]');
    if (metaHeader && metaHeader.getAttribute('content')) {
      const header = metaHeader.getAttribute('content').trim();
      if (header && header !== '' && header.startsWith('Bearer ')) {
        return header;
      }
    }

    // 2. Construct from token
    const token = getAuthToken();
    if (token) {
      return `Bearer ${token}`;
    }

    return null;
  }

  function isUserAuthenticated() {
    const metaAuth = document.querySelector('meta[name="is-authenticated"]');
    if (metaAuth) {
      return metaAuth.getAttribute('content') === 'true';
    }

    return getAuthToken() !== null;
  }

  // Show notification
  function showNotification(message, type) {
    // Simple notification implementation
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
    notification.textContent = message;

    document.body.appendChild(notification);

    setTimeout(() => {
      notification.remove();
    }, 3000);
  }

  // Debug information on page load
  document.addEventListener('DOMContentLoaded', function() {
    console.log('üîç Auth Debug Info:');
    console.log('- Is Authenticated:', isUserAuthenticated());
    console.log('- Auth Token:', getAuthToken() ? 'Present' : 'Missing');
    console.log('- Auth Header:', getAuthHeader() ? 'Present' : 'Missing');

    // Store card animations and hover effects
    const storeCards = document.querySelectorAll('.store-card');
    storeCards.forEach((card, index) => {
      // Stagger animation
      card.style.animationDelay = `${index * 0.1}s`;

      // Enhanced hover effects
      card.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-8px) scale(1.02)';
        this.style.boxShadow = 'var(--shadow-hover)';
      });

      card.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0) scale(1)';
        this.style.boxShadow = 'var(--shadow)';
      });
    });

    // Image error handling
    const images = document.querySelectorAll('.store-image');
    images.forEach((img) => {
      img.addEventListener('error', function() {
        console.log('Image failed to load:', this.src);
        this.style.display = 'none';
        const placeholder = this.nextElementSibling;
        if (placeholder && placeholder.classList.contains('store-image-placeholder')) {
          placeholder.style.display = 'flex';
        }
      });

      img.addEventListener('load', function() {
        console.log('Image loaded successfully:', this.src);
      });
    });

    // Enhanced search functionality
    const searchInput = document.querySelector('.search-input[name="search"]');
    if (searchInput) {
      let searchTimeout;
      searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          console.log('Search query:', this.value);
        }, 300);
      });
    }
  });

  // Search auto-complete (optional enhancement)
  const searchInput = document.querySelector('.search-input[name="search"]');
  if (searchInput) {
    let searchTimeout;
    searchInput.addEventListener('input', function() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        // Implement search suggestions if needed
      }, 300);
    });
  }
</script>
</body>
</html>